# GDash Apache Virtual Host
#
# Generated by Chef

<%- if node['gdash']['web']['should_put_namevirtualhost_directive_in_vhost_file'] %>
NameVirtualHost <%= node['gdash']['web']['interface'] %>:<%= node['gdash']['web']['port'] %>
<% end %>

<%- if node['gdash']['apache_auth']['realm'] != nil && node['gdash']['apache_auth']['vhost_servername'] != nil && node['apache_auth_group'] != nil %>
<VirtualHost <%= node['gdash']['web']['interface'] %>:<%= node['gdash']['web']['port'] %>>

  ServerName <%= node['gdash']['apache_auth']['vhost_servername'] %>
  <%- if node['gdash']['apache_auth']['vhost_server_aliases'] != nil %>
  ServerAlias <%= node['gdash']['apache_auth']['vhost_server_aliases'] * ' ' %>
  <%- end %>
  RewriteEngine ON
  RewriteRule ^(.*)$ http://<%= node['ipaddress'] %>:<%= node['gdash']['port'] %>$1 [P]

  <Location "/">
    # permit IP or user/pass
    Satisfy Any

    # IP
    # default Order is Deny,Allow
    Deny from all
    Allow from <%= node['ipaddress'] %> 

    # user/pass
    AuthUserFile <%= node['apache']['dir'] %>/users.digest 
    Require valid-user

    # common config 
    AuthType Digest
    AuthName "<%= node['gdash']['apache_auth']['realm'] %>"
    AuthDigestDomain http://<%= node['gdash']['apache_auth']['vhost_servername'] %>/ 
  </Location>

</VirtualHost>
<%- else %>
<VirtualHost <%= node['gdash']['web']['interface'] %>:<%= node['gdash']['web']['port'] %>>
  ServerName <%= node['gdash']['web']['hostname'] %>
  ServerAlias <%= node['gdash']['web']['hostname'] %>

  <Location "/">
    Order allow,deny
    Allow from all
    SetHandler None
  </Location>

  ProxyPass              /  http://<%= node['gdash']['interface'] %>:<%= node['gdash']['port'] %>/
  ProxyPassReverse       /  http://<%= node['gdash']['interface'] %>:<%= node['gdash']['port'] %>/
</VirtualHost>
<%- end %>
